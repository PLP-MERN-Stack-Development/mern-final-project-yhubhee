<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../partials/head') %>
    <title>Book Appointment - HealingNet</title>
</head>

<body>
    <div class="container my-5">
        <h3 class="text-center mb-4">Doctor’s Schedule</h3>

        <!-- Calendar Header -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <button id="prevBtn" class="btn btn-outline-secondary btn-sm">&laquo; Prev</button>
            <h5 id="monthYear" class="mb-0"></h5>
            <button id="nextBtn" class="btn btn-outline-secondary btn-sm">Next &raquo;</button>
        </div>

        <!-- Calendar Table -->
        <div class="table-responsive">
            <table class="table table-bordered table-hover text-center align-middle">
                <thead class="table-primary">
                    <tr>
                        <th>Sun</th>
                        <th>Mon</th>
                        <th>Tue</th>
                        <th>Wed</th>
                        <th>Thu</th>
                        <th>Fri</th>
                        <th>Sat</th>
                    </tr>
                </thead>
                <tbody id="calendarBody"></tbody>
            </table>
        </div>
    </div>

    <!-- ✅ Pass schedule data safely as JSON -->
    <script id="appointments-data" type="application/json">
        <%- JSON.stringify(schedule) %>
    </script>

    <script>
        const calendarBody = document.getElementById("calendarBody");
        const monthYear = document.getElementById("monthYear");
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");

        let currentDate = new Date();

        // ✅ Parse appointments from hidden JSON script
        const raw = document.getElementById("appointments-data").textContent;
        const appointments = JSON.parse(raw);
        const schedule = {};

        // ✅ Group appointments by YYYY-MM-DD
        appointments.forEach(appt => {
            const date = appt.appointmentDate.slice(0, 10); // avoid timezone shifts
            (schedule[date] ||= []).push({
                status: "Scheduled",
                time: appt.appointmentTime,
                patient: appt.fullname,
                type: "success"
            });
        });

        console.log("Final schedule object:", schedule);

        function renderCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();

            monthYear.textContent = date.toLocaleString("default", { month: "long" }) + " " + year;
            calendarBody.innerHTML = "";

            let row = document.createElement("tr");

            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                row.appendChild(document.createElement("td"));
            }

            for (let day = 1; day <= lastDate; day++) {
                const cell = document.createElement("td");
                const fullDate = `${year}-${String(month + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;

                // Day number
                cell.innerHTML = `<div>${day}</div>`;

                // ✅ Show multiple appointments stacked
                if (schedule[fullDate]) {
                    schedule[fullDate].forEach(({ status, time, patient, type }) => {
                        const badge = `<span class="badge bg-${type} d-block mt-1">${time} - ${patient}</span>`;
                        cell.innerHTML += badge;
                    });
                }

                row.appendChild(cell);

                // Start a new row after Saturday
                if ((firstDay + day) % 7 === 0) {
                    calendarBody.appendChild(row);
                    row = document.createElement("tr");
                }
            }

            // Add the last row if not empty
            if (row.children.length > 0) {
                calendarBody.appendChild(row);
            }
        }

        // Navigation
        prevBtn.addEventListener("click", () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(currentDate);
        });

        nextBtn.addEventListener("click", () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(currentDate);
        });

        // Initial render
        renderCalendar(currentDate);
    </script>
</body>
</html>
