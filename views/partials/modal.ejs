<!-- ============================ -->
<!-- Doctor Schedule Modal (EJS) -->
<!-- ============================ -->
<div class="modal fade" id="exampleModalCenter" tabindex="-1" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">

      <!-- Modal Header -->
      <div class="modal-header">
        <!-- Title updates dynamically with doctor’s name -->
        <h5 class="modal-title" id="exampleModalCenterTitle">Doctor Schedule</h5>
        <!-- Close button (Bootstrap 5 syntax: btn-close) -->
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <div class="container my-3">
          <!-- This heading is updated dynamically when a doctor is selected -->
          <h3 class="text-center mb-4" id="modalDoctorName">Doctor’s Schedule</h3>

          <!-- Calendar Header with navigation -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <!-- Buttons change the displayed month -->
            <button id="prevBtn" class="btn btn-outline-secondary btn-sm">&laquo; Prev</button>
            <h5 id="monthYear" class="mb-0"></h5> <!-- Displays current month/year -->
            <button id="nextBtn" class="btn btn-outline-secondary btn-sm">Next &raquo;</button>
          </div>

          <!-- Calendar Table -->
          <div class="table-responsive">
            <table class="table table-bordered table-hover text-center align-middle">
              <thead class="table-primary">
                <tr>
                  <th>Sun</th><th>Mon</th><th>Tue</th>
                  <th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
                </tr>
              </thead>
              <!-- Days & appointments will be dynamically inserted here -->
              <tbody id="calendarBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="modal-footer">
        <!-- Simple close button -->
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>

    </div>
  </div>
</div>

<!-- ========================================= -->
<!-- SAFELY embed server-side data as JSON -->
<!-- ========================================= -->
<!-- schedule: list of all appointments -->
<script id="appointments-data" type="application/json">
  <%- JSON.stringify(schedule || []).replace(/</g,'\\u003c') %>
</script>

<!-- doctors: list of all doctors -->
<script id="doctors-data" type="application/json">
  <%- JSON.stringify(doctors || []).replace(/</g,'\\u003c') %>
</script>

<script>
  (function () {
    // =========================
    // DOM references in modal
    // =========================
    const modal = document.getElementById('exampleModalCenter');
    const calendarBody = modal.querySelector('#calendarBody');
    const monthYear = modal.querySelector('#monthYear');
    const prevBtn = modal.querySelector('#prevBtn');
    const nextBtn = modal.querySelector('#nextBtn');
    const modalDoctorName = modal.querySelector('#modalDoctorName');

    // =========================
    // Parse embedded JSON safely
    // =========================
    const appointmentsRaw = JSON.parse(document.getElementById('appointments-data').textContent || '[]');
    const doctorsRaw = JSON.parse(document.getElementById('doctors-data').textContent || '[]');

    // State variables
    let currentDate = new Date(); // Controls which month is displayed
    let currentSchedule = {};     // Stores appointments grouped by date

    // ===================================================
    // Build a schedule object for one doctor (by doctorId)
    // Format: { 'YYYY-MM-DD': [ { time, appointmentEndtime, ... } ] }
    // ===================================================
    function buildScheduleForDoctor(doctorId) {
      const schedule = {};
      appointmentsRaw
        .filter(a => String(a.doctor_id) === String(doctorId)) // filter only this doctor’s appointments
        .forEach(appt => {
          const dateStr = (appt.appointmentDate || '').slice(0, 10); // YYYY-MM-DD
          if (!dateStr) return;
          // Push appointment into correct date array
          (schedule[dateStr] = schedule[dateStr] || []).push({
            status: 'Scheduled',
            time:  appt.appointmentTime || '',
            appointmentEndtime: appt.appointmentEndtime || '',
            type: 'danger' // badge color (Bootstrap class)
          });
        });

      return schedule;
    }

    // ==============================================
    // Render calendar UI for given schedule & month
    // ==============================================
    function renderCalendarForSchedule(scheduleObj, date) {
      const year = date.getFullYear();
      const month = date.getMonth();
      const firstDay = new Date(year, month, 1).getDay();     // Day index of month start
      const lastDate = new Date(year, month + 1, 0).getDate(); // Last day number

      // Display "Month Year" (e.g., March 2025)
      monthYear.textContent = date.toLocaleString('default', { month: 'long' }) + ' ' + year;

      // Clear old calendar content
      calendarBody.innerHTML = '';

      let row = document.createElement('tr');

      // Add empty cells before the first day of the month
      for (let i = 0; i < firstDay; i++) row.appendChild(document.createElement('td'));

      // Loop over all days in the month
      for (let day = 1; day <= lastDate; day++) {
        const cell = document.createElement('td');
        const fullDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

        // Add day number
        const dayDiv = document.createElement('div');
        dayDiv.textContent = day;
        cell.appendChild(dayDiv);

        // If there are appointments on this day, render them as badges
        (scheduleObj[fullDate] || []).forEach(item => {
          const span = document.createElement('span');
          span.className = 'badge bg-' + (item.type || 'secondary') + ' d-block mt-1 w-auto';
          span.textContent = `Doctor is booked from: ${item.time} - ${item.appointmentEndtime}`;
          cell.appendChild(span);
        });

        row.appendChild(cell);

        // Start a new row after Saturday
        if ((firstDay + day) % 7 === 0) {
          calendarBody.appendChild(row);
          row = document.createElement('tr');
        }
      }

      // Append last row if it still has cells
      if (row.children.length > 0) calendarBody.appendChild(row);
    }

    // =================================================
    // Event: When modal is opened (Bootstrap event)
    // Populate with correct doctor’s data
    // =================================================
    modal.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget; // Button that triggered the modal
      if (!button) return;

      // Get doctorId and doctorName from button dataset
      const doctorId = button.dataset.doctorId;
      const doctorNameAttr = button.dataset.doctorName || '';

      // If no name passed, try to find from doctors list
      const doctorFromList = doctorsRaw.find(d => String(d.doctor_id) === String(doctorId));
      const doctorName = doctorNameAttr || (doctorFromList && doctorFromList.doc_name) || 'Doctor Schedule';

      // Update modal header
      modalDoctorName.textContent = `${doctorName} — Schedule`;

      // Build schedule & render calendar starting at current month
      currentSchedule = buildScheduleForDoctor(doctorId);
      currentDate = new Date(); // reset to "today" when opened
      renderCalendarForSchedule(currentSchedule, currentDate);
    });

    // ==============================================
    // Navigation: Previous & Next month buttons
    // ==============================================
    prevBtn.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() - 1); // Go back one month
      renderCalendarForSchedule(currentSchedule, currentDate);
    });

    nextBtn.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() + 1); // Go forward one month
      renderCalendarForSchedule(currentSchedule, currentDate);
    });
  })();
</script>
